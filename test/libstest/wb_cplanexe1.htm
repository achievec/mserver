<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>工具管理 用例</title>
	<link href="js/css/bootstrap.min.css" rel="stylesheet">
	<link href="js/css/style.css" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="js/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="js/themes/icon.css">
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/jquery.easyui.min.js"></script>
	<script src="CTestClient.js"></script>
	<script src="/cservice/js"></script>
	<style type="text/css">
<!--
/************ Table ************/
.cplantable {border-collapse: collapse;border: 1px solid #ccc;}    
.cplantable thead td {font-size: 14px;color: #333333;text-align: center;background: repeat-x top center;border: 1px solid #ccc; font-weight:bold;}
.cplantable tbody tr {background: #fff;font-size: 12px;color: #666666;}           
.cplantable tbody tr.alt-row {background: #f2f7fc;}               
.cplantable td{line-height:20px;text-align: left;padding:4px 10px 3px 10px;height: 18px;border: 1px solid #ccc;}

.cplantext textarea {
-moz-box-shadow:0 0 0 #E7E7E7;
-moz-box-sizing:border-box;
border-color:#CCCCCC #999999 #999999 #CCCCCC;
border-style:solid;
border-width:0px;
font-family:arial,sans-serif;
font-size:12px;
height:100px;
margin:0px auto;
outline-color:-moz-use-text-color;
outline-style:none;
outline-width:medium;
padding:0px;
width:300px;
}
-->
</style>
</head>

<header class="navbar  navbar-fixed-top navbar-static-top bs-docs-nav" role="banner">
	<div class="navbar navbar-left">
		<nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
			<ul class="nav navbar-nav">
				<li><a href="/cplan.html">测试计划</a> </li>
				<li><a href="/cplancase.html">测试用例</a></li>
				<li><a href="/cplanenv.html">测试环境</a></li>
				<li><a href="/ctools.html">测试工具</a></li>
				<li><a href="cconfig.html">配置管理</a></li>
				<li class='active'><a href="#">测试执行</a></li>
			</ul>
		</nav>
	</div>
	<div class="navbar navbar-right">
			<ul class="nav navbar-nav">
				<li><a href='#' id='welcomeid'></a> </li>
			</ul>
	</div>
</header>
<script>
welcomeid.innerHTML = AuthApi.getLoginInfo().name+' 欢迎您'
</script>

<body class="easyui-layout">
	
	<div data-options="region:'north',border:false" style="height:10ptx;">
		<br><br><br>
	</div>

	<div data-options="region:'center'">
		<br>
		<table>
			<tr><td>目的&nbsp;&nbsp;&nbsp;&nbsp;</td><td id='planTarget'></td>
				<td align='right'>
					<a href="javascript:void(0)" class="easyui-linkbutton" onclick="treeTool.addCases()">添加用例</a>
					<a href="javascript:void(0)" class="easyui-linkbutton" onclick="treeTool.showDailyReport()">发送日报</a>
					<a href="javascript:void(0)" class="easyui-linkbutton" onclick="treeTool.showPlanReport()">生成测试报告</a>
				</td>
			</tr>
			<tr><td>详情</td><td id='planDetail' colspan=2></td></tr>
			
			<tr><td valign='top'>计划</td><td id='planSammary' colspan=2></td></tr>
		</table>

		<div id='dailyPannel' class="easyui-tabs" style="width:100%;">
			<div title="测试日报">
				<table id='plandailylist' style='height:500px' data-options='singleSelect:false,rownumbers:true,pagination:true,pageSize:20'></table>
			</div>
			<div title="测试用例">
				<div>
					<input id='condTagsName' size=15 class=easyui-textbox data-options="prompt:'测试场景'"/> 
					<input id='condCaseName' size=25 class=easyui-textbox data-options="prompt:'用例名'"/> 
					<input id='condOwner' size=15 class=easyui-textbox data-options="prompt:'修改人'"/> 
					<select id='condResult' onchange="treeTool.loadCases(1)">
						<option value="">测试结果</option> <option value="0">不涉及</option> <option value="1">通过</option> <option value="2">失败</option> <option value=5>阻塞</option> 
					</select>&nbsp;&nbsp;
					<input type='button' value='同步用例' title='同步用例更改到本计划中执行的用例中' onClick='treeTool.syncPlancases()'/>
				</div>
				<table id='plancaselist' style='height:500px' data-options='singleSelect:false,rownumbers:true,pagination:true,pageSize:20'></table>
			</div>
		</div>
	</div>

	<div id='caseAddDialog' class="easyui-dialog" title="添加测试用例" style="width:1100px;height:90%;align:top"
	    data-options="rownumbers:true,singleSelect:true, iconCls:'icon-save',resizable:true,modal:true,closable:true,closed:true">
	    <br>
		<table width='100%'><tr><td valign="top" style="width:200px">
	    	<ul class="easyui-tree" id="folder-list" data-options="animate:true,checkbox:false"></ul>
	    </td><td valign='top'>
	    	<input id="caseselects" size=100 class="easyui-combobox" data-options="multiple:true,panelHeight:'500px'" />
		</td><td valign='top' align='right'>
			<a href="javascript:void(0)" class="easyui-linkbutton" onclick="treeTool.saveCaseNode()">返回计划</a>
			<a href="javascript:void(0)" class="easyui-linkbutton" onclick="treeTool.saveCaseNode()">保存用例</a>
			&nbsp;&nbsp;&nbsp;&nbsp;
		</td></tr></table>
	</div>
	
	<div id='dailyAddDialog' class="easyui-dialog" title="写测试日报" style="width:1100px;height:550px;align:top"
	    data-options="rownumbers:true,singleSelect:true, iconCls:'icon-save',resizable:true,modal:true,closable:true,closed:true">
		<br>
	    <table width='100%'><tr>
			<td valign="top"> 进度:</td><td valign="top">

			<input id="dailyDay" size=8 value="2012-10-12" onChange='treeTool.showDailyReport(this.value)'/>
			<select id='planStatus'>
			<option value='2'>已创建</option>
			<option value='0'>有风险</option>
			<option value='1'>进行中</option>
			<option value='3'>已经完成</option>
			<option value='4'>暂停</option></select>
		</select>
			完成
			<input id="dailyProgress" size=1/>%（用例<label id='caseprogressshow'>30</label>%）&nbsp;
		<input id="dailyCostTime" size=1 value='8'/>小时&nbsp;&nbsp;
		<input id="dailyCostMan" size=1 value='1'/>人，开始于
		<input id='starttime' class="easyui-datebox"
			data-options="formatter:myformatter,parser:myparser"
			style="width: 100px" /> ~ <input id='endtime' class="easyui-datebox"
			data-options="formatter:myformatter,parser:myparser"
			style="width: 100px"/>
		</td>
		
		<td align='right'>
		<a href="javascript:void(0)" class="easyui-linkbutton" onclick="treeTool.saveDaily(0)">保存草稿</a>
		<a href="javascript:void(0)" class="easyui-linkbutton" onclick="treeTool.saveDaily(1)">发送日报</a>
		<a href="javascript:void(0)" class="easyui-linkbutton" onclick="treeTool.saveDaily(0);treeTool.showPlanReport()">测试报告</a>
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><br>
		</td></tr>
		<tr><td valign="top">当前进展:</td><td colspan=2><textarea id='dailySummary' rows=10 cols=136></textarea></td></tr>
		<tr><td valign="top">问题或风险:</td><td colspan=2><textarea id='dailyIssues' rows=10 cols=136></textarea></td></tr>
		</table> 
	</div>
	
	<div id='dailyEmail' class="easyui-dialog" title="发送日报" style="width:1100px;height:550px;align:top"
	    data-options="rownumbers:true,singleSelect:true, iconCls:'icon-save',resizable:true,modal:true,closable:true,closed:true">
		<br>
	    <table><tr>
			<td>收发: </td><td>
				&nbsp;&nbsp;From<input id='mailfrom' size=5/>&nbsp;To
				<input id='mailto' size=45/>&nbsp;cc
				<input id='mailcc' size=30/>
				&nbsp;&nbsp;
				<a href="javascript:void(0)" class="easyui-linkbutton" onclick="$('#dailyEmail').dialog('close');treeTool.showDailyReport()">返回日报</a>
				<a href="javascript:void(0)" class="easyui-linkbutton" onclick="treeTool.sendDailyEmail()">确定发送</a>
			</td></tr>
			<tr> <td><br> </td></td></tr>
			<tr> <td>主题: </td><td id='dailySubject'></td></tr>
			<tr><td>内容: </td><td id='dailyBody'></td></tr>
		</table> 
	</div>

	<div id='planReport' class="easyui-dialog" title="发送测试报告" style="width:1200px;height:90%;align:top"
	    data-options="rownumbers:true,singleSelect:true, iconCls:'icon-save',resizable:true,modal:true,closable:true,closed:true">
		<br>
<table class="cplantable" width='100%'>
	<tr>
	<td>收发 </td><td>
		&nbsp;&nbsp;From<input id='reportmailfrom' size=5/>&nbsp;To
		<input id='reportmailto' size=55/>&nbsp;cc
		<input id='reportmailcc' size=35/>&nbsp;&nbsp;
		<input id='reportisSetFinish' type='checkbox' checked />测试完成
		&nbsp;&nbsp;&nbsp;&nbsp;
		<a href="javascript:void(0)" class="easyui-linkbutton" onclick="$('#planReport').dialog('close');$('#dailyPannel').tabs('select','测试计划')">返回计划</a>
		<a href="javascript:void(0)" class="easyui-linkbutton" onclick="$('#planReport').dialog('close');$('#dailyPannel').tabs('select','测试用例')">返回用例</a>
		<a href="javascript:void(0)" class="easyui-linkbutton" onclick="treeTool.sendPlanSummaryReport()">确定发送</a>
	</td></tr>

	<tr><td width=70 style='white-space:nowrap'>测试目的</td> <td id='planReportTarget'></td> </tr>
	<tr><td>执行详情</td> <td id='planReportDetail'></td> </tr>
	<tr><td>测试总结</td> <td><textarea id='planreportSummary' rows=8 cols=165></textarea></td> </tr>
	<tr><td>遗留问题</td> <td><textarea id='planreportIssues' rows=8 cols=165></textarea></td> </tr>
	<tr><td colspan=2 style='background-color: #eeeeee;'><strong>用例执行</strong></td></tr> 
	<tr><td colspan=2 id='planReportCaseSummary'></td></tr>
</table>
	</div>

	<div id='caseremarkView' class="easyui-dialog" title="测试用例备注、修改" style="width:1100px;height:350px;align:top"
	    data-options="rownumbers:true,singleSelect:true, iconCls:'icon-save',resizable:true,modal:true,closable:true,closed:true">
		<br>
<table width="100%">
	<tr><td>测试场景</td> <td> <input id="plancasescenario" size="40"><input id="plancaseidremark" type='hidden'>
		<input id="caseidremark" type='hidden'>
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
		<a href="javascript:void(0)" class="easyui-linkbutton" onclick="treeTool.savePlancaseRemark()">保存用例备注</a>
	</td> </tr>
	<tr><td>测试要点</td> <td><br><textarea id='plancasename' rows=2 cols=120></textarea></td> </tr>
	<tr><td>用例备注</td> <td > <textarea id='plancaseremark' rows=4 cols=120></textarea> </td> </tr>
</table>
	</div>

</body>

<script type="text/javascript">
var riskStatusDefine = ['有风险','进行中','已创建', '已经完成','暂停']

Array.prototype.insert = function (index, item) {  
  this.splice(index, 0, item);  
};

Array.prototype.foreach = function(f, arg){
	for(var i=0; i<this.length;i+=1){
		var fr = f(i, this[i], arg)
		if(undefined != fr)
			return fr
	}
}

treeTool = {
	getTreeNodeData: function(fnid){
		var nodesData = CTestPlanAPi.getCtreeRoot(fnid)
		for(var i in nodesData){
			var n = nodesData[i]
			n['text'] = n['name']
			n['state'] = 'closed'
		}
		return nodesData
	},
	addCases: function(){
		$('#caseAddDialog').dialog('open')
		$("#dailyPannel").tabs("select","测试用例")
		$('#folder-list').tree({
			animate: true,
			data: treeTool.getTreeNodeData(0),
			onClick:function(node){
				treeTool.tree = node
				if(node.state=="open")
					$(this).tree('collapse',node.target)
				else
					$(this).tree('expand',node.target)

				var datas = CTestPlanAPi.getCtestcase(node.nid)
				for(var i in datas){
					var d = datas[i]
					d['casename'] = "【"+d['scenario']+"】  "+d['name']
					d['caseinfo'] = "" + d['caseid'] + "|,|"+ (d['scenario']?d['scenario']:"")+
						"|,|"+ (d['remark']?d['remark']:"") + "|,|"+ d['owner']+ "|,|"+ d['name']
				}
				$('#caseselects').combobox({valueField: 'caseinfo',
					textField: 'casename', 'data': datas})
			},
			onBeforeExpand: function(node){
				if(node.children==undefined)
					$(this).tree('append',{
						parent:node.target,
						data:treeTool.getTreeNodeData(node.nid)
					});
			}
		})
	},
	formatTime: function(t1, t2){
		return (t1?t1.split(' ')[0]:"") + "~" + (t2?t2.split(' ')[0]:"")
	},
