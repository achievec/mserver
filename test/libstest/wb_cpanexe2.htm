
	loadPlanAndcases: function(){
		var planData = CTestPlanAPi.getCtestplanById(condition.planid)[0]
		treeTool.planData = planData
		planTarget.innerHTML  = "<strong>【"+planData.ptype+"】"+"【"+planData.priority+"】"+planData.name+ " ("+planData.tags+")</strong>"
		planDetail.innerHTML  = "<pre>【描述】"+planData.summary+"<br>【风险】"+planData.issues+"</pre>"
		var planTime = treeTool.formatTime(planData.pstarttime, planData.pendtime)
		var actTime = treeTool.formatTime(planData.starttime, planData.endtime)
		planSammary.innerHTML =  planData.reportSummary
		treeTool.loadCases()
	},
	loadCases: function(isCondSearch){
		if(isCondSearch){
			var status=$("#condResult").val()
			var owner=$("#condOwner").val()
			var tagsName=$("#condTagsName").val()
			var caseName=$("#condCaseName").val()
		}else{
			var status=undefined
			var owner=undefined
			var caseName=undefined
		}
		var respVal = CTestPlanAPi.getPlancase(condition.planid,status,owner,tagsName,caseName)
		var respColumns =[
			{field:'caseid',title:'用例ID', formatter:function(value, row, index){
				return '<select onChange=\'treeTool.changeTestResult(' +row.plancaseid +', this.value)\'> <option>ID '+value+'</option> <option value=0>不涉及</option> <option value=1>通过</option> <option value=2>失败</option> <option value=5>阻塞</option> <option value=3>备注</option> <option value=4>删除</option> </select>'
			}},
			{field:'status',title:'结果',
				formatter:function(value, row, index){
					return ['不涉及', '通过', '失败', '','','阻塞'][value] }},
			{field:'tags',title:'父类',width:120},
			{field:'scenario',title:'测试场景',width:150},
			{field:'name',title:'用例描述',width:"45%"},

			{field:'owner',title:'修改人',width:80},
			{field:'modifytime',title:'修改时间',width:120},
			{field:'remark',title:'备注',width:300}
		]

		$('#plancaselist').datagrid({ columns:[respColumns], data: respVal, loadFilter: function(data){
			if (typeof data.length == 'number' && typeof data.splice == 'function'){
				data = { total: data.length, rows: data}
			}
			var dg = $(this);
			var opts = dg.datagrid('options');
			var pager = dg.datagrid('getPager');
			pager.pagination({
				onSelectPage:function(pageNum, pageSize){
					opts.pageNumber = pageNum;
					opts.pageSize = pageSize;
					pager.pagination('refresh',{ pageNumber:pageNum, pageSize:pageSize});
					dg.datagrid('loadData',data);
				}
			});
			if (!data.originalRows){ data.originalRows = (data.rows); }
			var start = (opts.pageNumber-1)*parseInt(opts.pageSize);
			var end = start + parseInt(opts.pageSize);
			data.rows = (data.originalRows.slice(start, end));
			return data;
		}})
	},
	saveDaily: function(isSendMail){
		var day = $("#dailyDay").val()
		var status = $("#planStatus").val()
		var progress = $("#dailyProgress").val()
		var caseprogress = 0
		var costtime = $("#dailyCostTime").val()
		var costman = $("#dailyCostMan").val()
		
		var starttime = $("#starttime").datebox("getValue")
		var endtime = $("#endtime").datebox("getValue")
		
		var summary = $("#dailySummary").val()
		var issues = $("#dailyIssues").val()

		CTestPlanAPi.savePlandaily(condition.planid, day, status, progress, caseprogress, 
			costtime, costman, starttime, endtime, summary, issues)
		treeTool.loadDailyList()
		if(isSendMail){
			$('#dailyAddDialog').dialog('close')
			treeTool.showDailyEmail(day)
		}
	},
	contentFormatter:function(value, row, index){
		return "<pre>"+value+"</pre>"
	},
	loadDailyList: function(){
		var respVal = CTestPlanAPi.getPlandaily(condition.planid)
		var respColumns =[{field:'day',title:'日期',width:80,
			formatter:function(value, row, index){
				return value.split(" ")[0]
			}},
			{field:'progress',title:'进度%',width:50},
			{field:'caseprogress',title:'用例进度%',width:60},
			{field:'costtime',title:'耗时',width:50,formatter:function(value, row, index){
				return value+"H*"+row.costman
			}},
			{field:'status',title:'状态',width:50, 
				formatter:function(value, row, index){
					return ['有风险','进行中','已创建', '已经完成','暂停'][value] }},
			{field:'summary',title:'进展详情', resizable:true, formatter:treeTool.contentFormatter},
			{field:'issues',title:'问题或风险', width:'50%',  formatter:treeTool.contentFormatter}]

		$('#plandailylist').datagrid({ columns:[respColumns], data: respVal, loadFilter: function(data){
			if (typeof data.length == 'number' && typeof data.splice == 'function'){
				data = { total: data.length, rows: data}
			}
			var dg = $(this);
			var opts = dg.datagrid('options');
			var pager = dg.datagrid('getPager');
			pager.pagination({
				onSelectPage:function(pageNum, pageSize){
					opts.pageNumber = pageNum;
					opts.pageSize = pageSize;
					pager.pagination('refresh',{ pageNumber:pageNum, pageSize:pageSize});
					dg.datagrid('loadData',data);
				}
			});
			if (!data.originalRows){ data.originalRows = (data.rows); }
			var start = (opts.pageNumber-1)*parseInt(opts.pageSize);
			var end = start + parseInt(opts.pageSize);
			data.rows = (data.originalRows.slice(start, end));
			return data;
		}})
	},
	changeTestResult: function(plancaseid, result){
		if(result==3){
			$('#caseremarkView').dialog('open')
			var plancase = $('#plancaselist').datagrid("getData").rows.foreach(function(i,v){ if(v.plancaseid==plancaseid) return v })
			$("#plancaseidremark").val(plancase.plancaseid)
			$("#caseidremark").val(plancase.caseid)
			$("#plancasescenario").val(plancase.scenario)
			$("#plancasename").val(plancase.name)
			$("#plancaseremark").val(plancase.remark)

		}else if(result==4){
			CTestPlanAPi.deletePlancase(plancaseid)
		}else if(result!=''){
			CTestPlanAPi.setPlancase(plancaseid, result)
		}
		treeTool.loadPlanAndcases()
	},
	saveCaseNode: function(){
		var selectVals = $('#caseselects').combobox("getValues")
		CTestPlanAPi.savePlancase(condition.planid, treeTool.tree.name, selectVals)
		$('#caseAddDialog').dialog('close')
		treeTool.loadPlanAndcases()
	},
	savePlancaseRemark: function(){
		CTestPlanAPi.savePlancaseRemark($("#plancaseidremark").val(),$("#caseidremark").val(), $("#plancasescenario").val(), $("#plancasename").val(), $("#plancaseremark").val())
		$('#caseremarkView').dialog('close')
		treeTool.loadPlanAndcases()
	},
	syncPlancases: function(){
		$.messager.progress({text:'同步中 ...',interval:10})
		setTimeout(function(){
			CTestPlanAPi.syncPlancase(condition.planid)
			$.messager.progress("close")
		},10)
	},
	showPlanReport: function(){
		var planData = treeTool.planData
		planReportTarget.innerHTML = "<strong>【"+planData.ptype+"】"+"【"+planData.priority+"】"+planData.name+ " ("+planData.tags+")</strong>"
		planReportDetail.innerHTML  = planData.reportSummary
		planReportCaseSummary.innerHTML = CTestPlanAPi.getCtestplancasereport(planData.planid)

		if(!treeTool.planData.mailfrom)
			treeTool.planData.mailfrom = treeTool.planData.owner
		$("#reportmailfrom").val(treeTool.planData.mailfrom)
		$("#reportmailto").val(treeTool.planData.mailto)
		$("#reportmailcc").val(treeTool.planData.mailcc)
		$('#planReport').dialog('open')
		var psummary = CTestPlanAPi.getPlanSummary(planData.planid)
		if(psummary){
			$("#planreportSummary").val(psummary.summary)
			$("#planreportIssues").val(psummary.issues)
		}
	},
	sendPlanSummaryReport: function(){
		var emailRes = CTestPlanAPi.sendPlanSummaryEmail(treeTool.planData.planid,$("#planreportSummary").val(),$("#planreportIssues").val(),
			$("#reportmailfrom").val(), $("#reportmailto").val(), $("#reportmailcc").val(), reportisSetFinish.checked)
		$.messager.show({title:'测试计划', msg:'发送结果: '+emailRes, timeout:2000,
				style:{ right:'', top:100, bottom:'' }})
		$('#planReport').dialog('close')
	},
	showDailyReport: function(today){
		$('#dailyAddDialog').dialog('open')
		$("#dailyPannel").tabs("select","测试日报")
		
		$("#planStatus").val(treeTool.planData.status)
		$("#dailyProgress").val(treeTool.planData.progress)
		
		$("#starttime").datebox("setValue", treeTool.planData.starttime)
		$("#endtime").datebox("setValue", treeTool.planData.endtime)
		caseprogressshow.innerHTML = CTestPlanAPi.countPlancase(treeTool.planData.planid, 1).percent

		if(!today) today = CTestPlanAPi.getDay()
		var daily = CTestPlanAPi.getPlandaily(condition.planid, today)
		$("#dailyDay").val(today)
		if(daily.length == 1)
			daily=daily[0]
		else
			daily=undefined
		if(daily){
			$("#dailyProgress").val(daily.progress)
			$("#dailyCostTime").val(daily.costtime)
			$("#dailyCostMan").val(daily.costman)
			$("#dailySummary").val(daily.summary)
			$("#dailyIssues").val(daily.issues)
		}
	},
	showDailyEmail: function(day){
		treeTool.emailDay = day
		$('#dailyEmail').dialog('open')
		if(!treeTool.planData.mailfrom)
			treeTool.planData.mailfrom = treeTool.planData.owner
		$("#mailfrom").val(treeTool.planData.mailfrom)
		$("#mailto").val(treeTool.planData.mailto)
		$("#mailcc").val(treeTool.planData.mailcc)
		var dailyEmail = CTestPlanAPi.getPlandailyEmail(condition.planid, treeTool.emailDay)
		dailySubject.innerHTML = dailyEmail[0]
		dailyBody.innerHTML = dailyEmail[1]
	},
	sendDailyEmail:function(){
		var sender = $("#mailfrom").val()
		var receiver = $("#mailto").val()
		var ccReceiver = $("#mailcc").val()
		var emailRes = CTestPlanAPi.sendPlandailyEmail(condition.planid, treeTool.emailDay, sender, receiver, ccReceiver)
		$.messager.show({title:'测试计划', msg:'发送结果: '+emailRes, timeout:2000,
			style:{ right:'', top:100, bottom:'' }})
		if(emailRes=='Success')
			window.location.reload()
	}
}

condition = DataOperation.GetCondition()

treeTool.loadPlanAndcases()
treeTool.loadDailyList()
$(".easyui-textbox").textbox({ onChange: function(nv, ov){
	treeTool.loadCases(1)
}})
//setTimeout(treeTool.showPlanReport,1)
</script>

</html>
